{% load staticfiles %}
<!DOCTYPE html>
<html>

<head>
    <title> </title>
    <script src="https://unpkg.com/vue"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.19.2/axios.min.js"></script>
    <link rel="stylesheet" href="{% static 'assets/css/bootstrap.min.css' %}">
<script src="{% static  'assets/js/jq/jquery.min.js' %}"></script>
    <!-- template for the modal component -->

    <script type="text/x-template" id="modal-template">
        <transition name="modal" >
            <div class="modal-mask row">
           
<div class="col-lg-2  col-4 col-md-2 col-ms-4 nav-menu row"   style="">

<ul class="nav flex-column " id = "nav">
  <li class="nav-item">

 
      <img  src='{% static  '/icon/home.png' %}'  @click="folders_home"   style="height:25px; width: auto;">   Домашняя</img>
  </li>
  <li class="nav-item" >
   <img  src='{% static  '/icon/file.png'  %}'  @click="get_folders_spec('doc')"     style="height:25px; width: auto;" >  Документы </img>
  </li>
  <li class="nav-item"   @click="get_folders_spec('zagr')"     >
    Загрузки
  </li>
  <li class="nav-item"   @click="get_folders_spec('desktop')"  >
   Рабоий стол
  </li>
</ul>

</div>



                    <div class="modal-container col-8 col-lg-10 col-md-10 col-ms-8">
{% include "template_modal.html"%}
                    </div>
       
            </div>
        </transition>
    </script>
</head>

<body>
    <!-- app 

        {{files_to_transfer}}
    -->
    {% verbatim %}
    <div id="app">


<!--        <button id="show-modal" @click="showModal = true">Show Modal</button> -->

        <modal v-if="showModal" @close="showModal = false" :files='files'  :search_dirs='search_dirs'>
            <h3 slot="header"></h3>
        </modal>
        
{% endverbatim %}

 

{% verbatim %}
    </div>

    <script>
/*
$('body').on('keypress','#search-input', function(){
  if (typeof timer !== "undefined"){
    timer =  clearTimeout(timer)if (typeof timer !== "undefined"){
    timer =  clearTimeout(timer)
  
    timer = setTimeout(function(){alert($('#search-input').val());clearTimeout(timer); delete timer  }, 500)
  }else{
  
   timer = setTimeout(function(){alert($('#search-input').val());clearTimeout(timer); delete timer  }, 500)
  }
}) */


        Vue.component("modal", {
            props: ['files','search_dirs'],
            template: "#modal-template",
            methods:{
                folders_up_level: function(){
                    this.$root.$options.methods.folders_up_level()
                },
                get_folders_spec: function(name){
                    this.$root.$options.methods.get_folders_spec(name)
                },
                folders_home: function(){
                
                    this.$root.$options.methods.folders_home()
                },
                 folders_home: function(){
                
                    this.$root.$options.methods.folders_home()
                },  
                send: function(){
                    this.$root.$options.methods.send()
                },
                close: function(){
                    window.close()
                }


            }

        });



        Vue.component("nav", {
            props: [''],
            template: "#nav",
            methods:{


            }

        });



        Vue.component("file", {
            props: ['file'],
           {% endverbatim %}
            template: "<span class='file'> <img  src='{% static  '/img/folder.png' %}'@click='click(file)' >  </img> <span class='file-podp'> {% verbatim %} {{file}}  </span> </span>" ,
                
            methods:{
                click: function(name){
                 this.$root.$options.methods.get_data_folder(name)
                },
               
            }
                    });

        Vue.component("search_dir", {
            props: ['dir'],
           {% endverbatim %}
            template: "<span class='file'> <img  src='{% static  '/img/folder.png' %}'@click='click(dir.pwd,dir.key)' >  </img> <span class='file-podp'> {% verbatim %} {{dir.key}}  </span> </span>" ,
                
            methods:{
                click: function(path, key){
                 this.$root.$options.methods.get_data_folder_from_search('/' + path,key)
                },
               
            }
        });




       Vue.component("my-input", {
            props: [''],
            data(){
                return{
                    name:'name'
                }
            },
            template: `<div id="search">
<span class="" style="position: absolute; right:40px; display: inline-block; direction: ltr; ">
<input type="search"  class="form-control ds-input" v-model='name' id="search-input" placeholder=""    autocomplete="off" spellcheck="false" role="combobox" aria-autocomplete="list" style="position: relative; vertical-align: top;"><pre aria-hidden="true" style="position: absolute; visibility: hidden; white-space: pre; font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Roboto, &quot;Helvetica Neue&quot;, Arial, sans-serif, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;, &quot;Segoe UI Symbol&quot;; font-size: 20px; font-style: normal; font-variant: normal; font-weight: 400; word-spacing: 0px; letter-spacing: normal; text-indent: 0px; text-rendering: auto; text-transform: none;"></pre><span class="ds-dropdown-menu" role="listbox" id="algolia-autocomplete-listbox-0" style="position: absolute; top: 100%; z-index: 100; display: none; left: 0px; right: auto;">
<div class="ds-dataset-1"></div></span></span>
</div>`,
watch: {
  'name': function(newval,old) {
   fun = this.$root.$options.methods.search_f


  if (typeof timer !== "undefined"){
    timer =  clearTimeout(timer)

    timer = setTimeout(function(){fun(newval);clearTimeout(timer); delete timer  }, 500)
  }else{

   timer = setTimeout(function(){fun(newval);clearTimeout(timer); delete timer  }, 500)
  }

       
  }
}

        });
 

        var vebs = new Vue({
            el: "#app",
            data() {
                return{
                showModal: true,
                files: [""],
                search:'',
                old_files:[],
                search_dirs:[],
                old_curent_path:[],
                curent_path:'',
                {% endverbatim %}
                files_to_transfer: '{{files}}'.split(' ')
                {%  verbatim %}

                }
            },
            mounted() {
      {% endverbatim %}


                axios
                    .get('{% url "get_content_dir" %}',{
                        params:{
                            get_transition_path: ''
                        }
                    })
               
                    .then(response => this.update_vision_folder(response.data, '') )
            },
            methods: {

                search_f: function(name){
                  var params = new URLSearchParams();
                    params.append('name', name)
                
                     axios.
                    get('{% url "search_dir"  %}',{
                        params: {
                            search: name
                        }}
                        ) 
                        .then(response => vebs.update_vision_folder_search(response.data, name)  ) 
        


                },
                 update_vision_folder_search: function(response, name){ 
                          if (name.length > 0){
                         
                          if (vebs.old_files.length > 0){
                              console.log('yes')
                            
                          }else{
                              console.log('no')
                          vebs.old_curent_path =  vebs.curent_path
                            vebs.old_files = vebs.files
                             vebs.files = []
                         
                          }
                         
                          //vebs.search_dirs = name.split(' ')
                          for (key in response) {
                              console.log(key + " " + String(response[key]).replace(/,/g,'/')  )
                              vebs.search_dirs.push({
                                  key: key.replace(/\s{2,}/g, ' ').trim(),
                                  pwd: String(response[key]).replace(/\s{2,}/g, ' ').replace(/,/g,'/').trim()
                              })
                          }
                        }else{
                            vebs.files = vebs.old_files
                            vebs.old_files =  []
                            vebs.search_dirs = []
                            vebs.curent_path =  vebs.old_curent_path
                        }
                        
                          
                 },
                send: function(){
                    var params = new URLSearchParams();
                    params.append('files', vebs.files_to_transfer);
                    params.append('dir_', vebs.curent_path);
                    axios.
                    post('{% url  "send_files" %}',params)
                },
                get_folders_spec: function(name){
           
                    this.get_data_folder('+spec_' + name)
                },
                get_data_folder: function(name){
                    name = name ? name : ''
                
                    axios.
                    get('{% url "get_content_dir"  %}',{
                        params: {
                            get_transition_path:  '+spec' != name.split('_')[0]  ? vebs.curent_path +  name  : name
                        }}
                        )
                        .then(response => this.update_vision_folder(response.data, name)  ) 
                },
                get_data_folder_from_search: function(path,key){
                    axios.
                        get('{% url "get_content_dir"  %}',{
                            params: {
                                get_transition_path:  path + '/' + key
                            }
                            }).then(response => this.update_vision_folder(response.data, key)  ) 
                },
                update_vision_folder: function(response, name){
                    vebs.search_dirs = [],
                     vebs.files =  response['dirs']
                     
                     vebs.curent_path =  response['cur_path'] 
                     //vebs.curent_path  +  name + '/'
                    if (vebs.files.length == 0){
                        $('.modal-body > .not_fold').remove()
$('.modal-body').append('<h1 class="not_fold"> В этой папке нет папок. </h1>')
                     }else{
                         $('.modal-body>h1').remove()
                     } 
                      
                },
                 folders_up_level: function(){
                   vebs.curent_path = vebs.curent_path.split('/').slice(0,-2).join('/')
                   vebs.get_data_folder()
                },
                 folders_home: function(){
                   vebs.curent_path = ''
                   vebs.get_data_folder()

                }
            }
        });
//setTimeout(function(){window.close()}, 4000)



    </script>
   

    <style>
        .modal{ 
            height: 400px;
         }

         .file{
            position:  relative;
            margin: 4px  ;
            overflow: hidden;
         }
         .file-podp{
         position: absolute;
         
         left:5px; 
         top:56%; 
         font-weight: bold;
         font-size:10px;
          }
        .modal-mask {
            position: fixed;
            z-index: 9998;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
  
            transition: opacity 0.3s ease;

        }
.file>img{
height: 80px;
}
        
        .modal-container {
            
         
            background-color: #fff;
            border-radius: 2px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.33);
            transition: all 0.3s ease;
            font-family: Helvetica, Arial, sans-serif;
            min-height: 100vh;
            overflow: scroll;
            height: 100%;
    max-height: 551px;
        }
        
        .modal-header h3 {
            margin-top: 0;
            color: #42b983;
        }
        
        .modal-body {
            margin: 0px 0;
           display: flex; 
          flex-direction: column;
         height: 500px;
            flex-wrap: wrap;
           
            width: 100%;
                overflow-x: auto;
            
        }
        
        .modal-default-button {
            float: right;
        }
        /*
 * The following styles are auto-applied to elements with
 * transition="modal" when their visibility is toggled
 * by Vue.js.
 *
 * You can easily play with the modal transition by editing
 * these styles.
 */
        
        .modal-enter {
            opacity: 0;
        }
        
        .modal-leave-active {
            opacity: 0;
        }
        
        .modal-enter .modal-container,
        .modal-leave-active .modal-container {
            -webkit-transform: scale(1.1);
            transform: scale(1.1);
        }

        .button-group{
            display:flex;
      
        }
.nav-menu{ 
        float:left; 
        height: 100%;
          background-color: currentColor;
} 

.nav-item{
    color:white;
}
 li {
    list-style-type: none; /* Убираем маркеры */
   }
   li.nav-item {
    padding: 25px 5px;
    margin-left: 20%;
}
    </style>
</body>

</html>